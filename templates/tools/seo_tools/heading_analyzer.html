{% extends 'base.html' %}
{% block title %}Heading Structure Analyzer{% endblock %}
{% block content %}
<div class="min-h-screen bg-gradient-to-br from-amber-50 via-orange-50 to-red-50 py-12">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-amber-100 rounded-xl mb-4">
                <span class="text-2xl">üèóÔ∏è</span>
            </div>
            <h1 class="text-4xl font-bold bg-gradient-to-r from-amber-600 to-red-600 bg-clip-text text-transparent mb-2">Heading Structure Analyzer</h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">Analyze H1-H6 heading structure for better SEO</p>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <form id="headingForm">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Website URL</label>
                    <input type="url" name="url" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="https://example.com">
                    <p class="text-sm text-gray-500 mt-2">We'll analyze the heading structure of this webpage</p>
                </div>
                <button type="submit" class="w-full mt-6 bg-gradient-to-r from-amber-600 to-red-600 text-white py-3 rounded-lg hover:shadow-lg transition-all">Analyze Heading Structure</button>
            </form>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden space-y-8">
            <!-- Overview Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div class="bg-white rounded-2xl shadow-lg p-6 text-center border border-gray-100">
                    <div class="text-3xl font-bold text-amber-600" id="totalHeadings">0</div>
                    <div class="text-gray-600 text-sm">Total Headings</div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 text-center border border-gray-100">
                    <div class="text-3xl font-bold text-orange-600" id="h1Count">0</div>
                    <div class="text-gray-600 text-sm">H1 Tags</div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 text-center border border-gray-100">
                    <div class="text-3xl font-bold text-red-600" id="hierarchyIssues">0</div>
                    <div class="text-gray-600 text-sm">Issues Found</div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 text-center border border-gray-100">
                    <div class="text-2xl font-bold" id="seoScore">-</div>
                    <div class="text-gray-600 text-sm">SEO Score</div>
                </div>
            </div>

            <!-- Heading Hierarchy Visualization -->
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6">üìã Heading Hierarchy</h3>
                <div id="headingHierarchy" class="space-y-2">
                </div>
            </div>

            <!-- Heading Distribution -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Heading Counts -->
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">üìä Heading Distribution</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 font-mono">H1</span>
                            <div class="flex items-center space-x-2">
                                <span class="text-lg font-semibold text-amber-600" id="h1CountDetail">-</span>
                                <div class="w-24 bg-gray-200 rounded-full h-2">
                                    <div id="h1Bar" class="bg-amber-500 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 font-mono">H2</span>
                            <div class="flex items-center space-x-2">
                                <span class="text-lg font-semibold text-orange-600" id="h2CountDetail">-</span>
                                <div class="w-24 bg-gray-200 rounded-full h-2">
                                    <div id="h2Bar" class="bg-orange-500 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 font-mono">H3</span>
                            <div class="flex items-center space-x-2">
                                <span class="text-lg font-semibold text-red-600" id="h3CountDetail">-</span>
                                <div class="w-24 bg-gray-200 rounded-full h-2">
                                    <div id="h3Bar" class="bg-red-500 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 font-mono">H4</span>
                            <div class="flex items-center space-x-2">
                                <span class="text-lg font-semibold text-pink-600" id="h4CountDetail">-</span>
                                <div class="w-24 bg-gray-200 rounded-full h-2">
                                    <div id="h4Bar" class="bg-pink-500 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 font-mono">H5</span>
                            <div class="flex items-center space-x-2">
                                <span class="text-lg font-semibold text-purple-600" id="h5CountDetail">-</span>
                                <div class="w-24 bg-gray-200 rounded-full h-2">
                                    <div id="h5Bar" class="bg-purple-500 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 font-mono">H6</span>
                            <div class="flex items-center space-x-2">
                                <span class="text-lg font-semibold text-indigo-600" id="h6CountDetail">-</span>
                                <div class="w-24 bg-gray-200 rounded-full h-2">
                                    <div id="h6Bar" class="bg-indigo-500 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SEO Analysis -->
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">üéØ SEO Analysis</h3>
                    <div id="seoAnalysis" class="space-y-4">
                    </div>
                </div>
            </div>

            <!-- Issues and Recommendations -->
            <div id="issuesSection" class="bg-red-50 rounded-2xl p-8 border border-red-200 hidden">
                <h3 class="text-xl font-bold text-red-800 mb-4">‚ö†Ô∏è Hierarchy Issues</h3>
                <ul id="hierarchyIssuesList" class="space-y-2 text-red-700">
                </ul>
            </div>

            <!-- SEO Recommendations -->
            <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl p-8 border border-amber-200">
                <h3 class="text-xl font-bold text-amber-800 mb-4">üí° SEO Recommendations</h3>
                <div id="recommendationsList" class="space-y-2 text-amber-700">
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingSection" class="hidden text-center py-12">
            <div class="inline-flex items-center justify-center w-12 h-12 border-4 border-amber-200 border-t-amber-600 rounded-full animate-spin mb-4"></div>
            <p class="text-gray-600">Analyzing heading structure...</p>
        </div>

        <!-- Error State -->
        <div id="errorSection" class="hidden bg-red-50 border border-red-200 rounded-2xl p-6 text-center">
            <div class="text-red-600 text-lg font-medium mb-2">Analysis Failed</div>
            <p class="text-red-600" id="errorMessage"></p>
        </div>
    </div>
</div>

<script>
document.getElementById('headingForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // Show loading, hide others
    document.getElementById('loadingSection').classList.remove('hidden');
    document.getElementById('resultsSection').classList.add('hidden');
    document.getElementById('errorSection').classList.add('hidden');
    
    try {
        const response = await fetch('/tools/heading-analyzer', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        document.getElementById('loadingSection').classList.add('hidden');
        
        if (data.success) {
            displayResults(data);
        } else {
            showError(data.error || 'Analysis failed');
        }
    } catch (error) {
        document.getElementById('loadingSection').classList.add('hidden');
        showError('Network error occurred');
    }
});

function displayResults(data) {
    // Update overview stats
    document.getElementById('totalHeadings').textContent = data.total_headings.toLocaleString();
    document.getElementById('h1Count').textContent = data.h1_count.toLocaleString();
    document.getElementById('hierarchyIssues').textContent = data.hierarchy_issues.length.toString();
    
    // Calculate and display SEO score
    const seoScore = calculateSeoScore(data);
    const scoreElement = document.getElementById('seoScore');
    scoreElement.textContent = seoScore + '%';
    scoreElement.className = seoScore >= 80 ? 'text-2xl font-bold text-green-600' :
                             seoScore >= 60 ? 'text-2xl font-bold text-yellow-600' :
                             'text-2xl font-bold text-red-600';
    
    // Display heading hierarchy
    displayHeadingHierarchy(data.headings);
    
    // Update heading distribution
    updateHeadingDistribution(data.heading_counts, data.total_headings);
    
    // Display SEO analysis
    displaySeoAnalysis(data);
    
    // Show hierarchy issues if any
    if (data.hierarchy_issues.length > 0) {
        const issuesList = document.getElementById('hierarchyIssuesList');
        issuesList.innerHTML = '';
        data.hierarchy_issues.forEach(issue => {
            const li = document.createElement('li');
            li.textContent = issue;
            issuesList.appendChild(li);
        });
        document.getElementById('issuesSection').classList.remove('hidden');
    }
    
    // Generate recommendations
    generateRecommendations(data);
    
    document.getElementById('resultsSection').classList.remove('hidden');
}

function displayHeadingHierarchy(headings) {
    const container = document.getElementById('headingHierarchy');
    container.innerHTML = '';
    
    if (headings.length === 0) {
        container.innerHTML = '<p class="text-gray-500 italic">No headings found on this page</p>';
        return;
    }
    
    headings.forEach((heading, index) => {
        const headingElement = document.createElement('div');
        headingElement.className = 'flex items-start space-x-3 p-3 border-l-4 border-gray-200 hover:bg-gray-50';
        
        const colors = {
            1: 'border-amber-500 bg-amber-50',
            2: 'border-orange-500 bg-orange-50',
            3: 'border-red-500 bg-red-50',
            4: 'border-pink-500 bg-pink-50',
            5: 'border-purple-500 bg-purple-50',
            6: 'border-indigo-500 bg-indigo-50'
        };
        
        headingElement.className = `flex items-start space-x-3 p-3 ${colors[heading.level]} rounded-r-lg`;
        
        const indent = '&nbsp;'.repeat((heading.level - 1) * 4);
        
        headingElement.innerHTML = `
            <div class="flex-shrink-0">
                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">
                    ${heading.tag.toUpperCase()}
                </span>
            </div>
            <div class="flex-grow min-w-0">
                <div class="text-sm font-medium text-gray-900 break-words">${indent}${heading.text}</div>
                <div class="text-xs text-gray-500 mt-1">${heading.length} characters</div>
            </div>
        `;
        
        container.appendChild(headingElement);
    });
}

function updateHeadingDistribution(headingCounts, totalHeadings) {
    const maxCount = Math.max(...Object.values(headingCounts));
    
    for (let i = 1; i <= 6; i++) {
        const count = headingCounts[`h${i}`] || 0;
        document.getElementById(`h${i}CountDetail`).textContent = count;
        
        const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
        document.getElementById(`h${i}Bar`).style.width = percentage + '%';
    }
}

function displaySeoAnalysis(data) {
    const analysis = document.getElementById('seoAnalysis');
    const checks = [
        {
            label: 'Has H1 Tag',
            status: data.has_h1,
            description: data.has_h1 ? 'Good! Page has H1 tag' : 'Missing H1 tag'
        },
        {
            label: 'Single H1',
            status: !data.multiple_h1,
            description: data.multiple_h1 ? 'Multiple H1 tags found' : 'Good! Only one H1 tag'
        },
        {
            label: 'Proper Hierarchy',
            status: data.hierarchy_issues.length === 0,
            description: data.hierarchy_issues.length === 0 ? 'Good heading hierarchy' : `${data.hierarchy_issues.length} hierarchy issues`
        },
        {
            label: 'Has Structure',
            status: data.total_headings > 1,
            description: data.total_headings > 1 ? 'Good content structure' : 'Consider adding more headings'
        }
    ];
    
    analysis.innerHTML = '';
    checks.forEach(check => {
        const checkElement = document.createElement('div');
        checkElement.className = 'flex items-center justify-between p-3 rounded-lg ' + 
                                 (check.status ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200');
        
        checkElement.innerHTML = `
            <div>
                <div class="text-sm font-medium ${check.status ? 'text-green-800' : 'text-red-800'}">${check.label}</div>
                <div class="text-xs ${check.status ? 'text-green-600' : 'text-red-600'}">${check.description}</div>
            </div>
            <div class="text-lg ${check.status ? 'text-green-600' : 'text-red-600'}">
                ${check.status ? '‚úì' : '‚úó'}
            </div>
        `;
        
        analysis.appendChild(checkElement);
    });
}

function calculateSeoScore(data) {
    let score = 0;
    
    // Has H1 (25 points)
    if (data.has_h1) score += 25;
    
    // Single H1 (25 points)
    if (!data.multiple_h1) score += 25;
    
    // No hierarchy issues (25 points)
    if (data.hierarchy_issues.length === 0) score += 25;
    
    // Has good structure (25 points)
    if (data.total_headings > 2) score += 25;
    
    return score;
}

function generateRecommendations(data) {
    const recommendations = [];
    
    if (!data.has_h1) {
        recommendations.push('Add an H1 tag to clearly define the main topic of your page');
    }
    
    if (data.multiple_h1) {
        recommendations.push('Use only one H1 tag per page for better SEO structure');
    }
    
    if (data.hierarchy_issues.length > 0) {
        recommendations.push('Fix heading hierarchy issues to improve content structure');
    }
    
    if (data.total_headings < 3) {
        recommendations.push('Add more headings to improve content organization and readability');
    }
    
    if (data.heading_counts.h2 === 0 && data.total_headings > 1) {
        recommendations.push('Consider using H2 tags to create main sections in your content');
    }
    
    if (recommendations.length === 0) {
        recommendations.push('Excellent heading structure! Your page follows SEO best practices üéâ');
    }
    
    const recommendationsList = document.getElementById('recommendationsList');
    recommendationsList.innerHTML = '';
    recommendations.forEach(rec => {
        const li = document.createElement('div');
        li.textContent = rec;
        li.className = 'text-amber-700';
        recommendationsList.appendChild(li);
    });
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorSection').classList.remove('hidden');
}
</script>
{% endblock %}