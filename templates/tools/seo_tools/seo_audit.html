{% extends 'base.html' %}

{% block title %}SEO Audit Tool{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-green-50 via-blue-50 to-teal-50 py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-12">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-xl mb-4">
                <span class="text-2xl">üîç</span>
            </div>
            <h1 class="text-4xl font-bold bg-gradient-to-r from-green-600 to-teal-600 bg-clip-text text-transparent mb-2">
                SEO Audit Tool
            </h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                Get a comprehensive analysis of your website's SEO health and performance
            </p>
        </div>

        <!-- Input Form -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 border border-gray-100">
            <form id="seoAuditForm" class="space-y-6">
                <div>
                    <label for="website_url" class="block text-sm font-medium text-gray-700 mb-2">
                        Website URL <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <input type="url" 
                               id="website_url" 
                               name="website_url" 
                               required
                               placeholder="https://example.com"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent pl-12">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="audit_depth" class="block text-sm font-medium text-gray-700 mb-2">Audit Depth</label>
                        <select id="audit_depth" name="audit_depth" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="quick">Quick Scan (5 pages)</option>
                            <option value="standard" selected>Standard (25 pages)</option>
                            <option value="deep">Deep Audit (100 pages)</option>
                        </select>
                    </div>
                    <div>
                        <label for="include_mobile" class="flex items-center">
                            <input type="checkbox" 
                                   id="include_mobile" 
                                   name="include_mobile" 
                                   checked
                                   class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                            <span class="ml-2 text-sm font-medium text-gray-700">Include Mobile Analysis</span>
                        </label>
                    </div>
                </div>

                <button type="submit" 
                        id="submitBtn"
                        class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white font-semibold py-3 px-6 rounded-lg hover:from-green-700 hover:to-teal-700 transition-all duration-300 focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    <span class="flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        Run SEO Audit
                    </span>
                </button>
            </form>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden bg-white rounded-2xl shadow-xl p-8 text-center border border-gray-100">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-green-600 mx-auto mb-4"></div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Analyzing Your Website...</h3>
            <p class="text-gray-600">This may take a few moments. Please wait while we audit your site.</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden bg-white rounded-2xl shadow-xl p-8 text-center border border-gray-100">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="text-2xl">‚ö†Ô∏è</span>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Analysis Failed</h3>
            <p id="errorMessage" class="text-gray-600 mb-4">Something went wrong during the analysis.</p>
            <button id="tryAgainBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
                Try Again
            </button>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <!-- SEO Score Overview -->
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 border border-gray-100">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">SEO Score Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div class="w-24 h-24 mx-auto mb-4 relative">
                            <canvas id="overallScoreChart" width="96" height="96"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="overallScore" class="text-xl font-bold text-gray-900">0</span>
                            </div>
                        </div>
                        <h3 class="font-semibold text-gray-900">Overall Score</h3>
                    </div>
                    <div class="text-center">
                        <div class="w-24 h-24 mx-auto mb-4 relative">
                            <canvas id="techScoreChart" width="96" height="96"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="techScore" class="text-xl font-bold text-gray-900">0</span>
                            </div>
                        </div>
                        <h3 class="font-semibold text-gray-900">Technical SEO</h3>
                    </div>
                    <div class="text-center">
                        <div class="w-24 h-24 mx-auto mb-4 relative">
                            <canvas id="contentScoreChart" width="96" height="96"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="contentScore" class="text-xl font-bold text-gray-900">0</span>
                            </div>
                        </div>
                        <h3 class="font-semibold text-gray-900">Content Quality</h3>
                    </div>
                    <div class="text-center">
                        <div class="w-24 h-24 mx-auto mb-4 relative">
                            <canvas id="performanceScoreChart" width="96" height="96"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="performanceScore" class="text-xl font-bold text-gray-900">0</span>
                            </div>
                        </div>
                        <h3 class="font-semibold text-gray-900">Performance</h3>
                    </div>
                </div>
            </div>

            <!-- Detailed Issues -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Critical Issues -->
                <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
                            <span class="text-red-600">‚ö†Ô∏è</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">Critical Issues</h3>
                    </div>
                    <div id="criticalIssues" class="space-y-4">
                        <!-- Issues will be populated here -->
                    </div>
                </div>

                <!-- Warnings -->
                <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
                            <span class="text-yellow-600">‚ö°</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">Warnings</h3>
                    </div>
                    <div id="warnings" class="space-y-4">
                        <!-- Warnings will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="mt-8 text-center">
                <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Export Your Report</h3>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button id="newAnalysisBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                            New Analysis
                        </button>
                        <button id="exportPDF" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors">
                            Export as PDF
                        </button>
                        <button id="exportCSV" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
                            Export as CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('SEO Audit page loaded');
    
    const form = document.getElementById('seoAuditForm');
    const loadingState = document.getElementById('loadingState');
    const resultsSection = document.getElementById('resultsSection');
    const errorState = document.getElementById('errorState');
    const submitBtn = document.getElementById('submitBtn');
    const tryAgainBtn = document.getElementById('tryAgainBtn');

    // Check if elements exist
    if (!form) {
        console.error('Form not found');
        return;
    }
    
    // Ensure form is always visible on page load
    form.style.display = 'block';
    console.log('Form found, adding event listener');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Form submitted');
        
        // Show loading state
        form.style.display = 'none';
        loadingState.classList.remove('hidden');
        resultsSection.classList.add('hidden');
        
        const formData = new FormData(form);
        console.log('Form data prepared');
        
        try {
            console.log('Making fetch request to:', '{{ url_for("tools.seo_audit") }}');
            
            const response = await fetch('{{ url_for("tools.seo_audit") }}', {
                method: 'POST',
                body: formData
            });
            
            console.log('Response received:', response.status);
            
            const data = await response.json();
            console.log('Data received:', data);
            
            if (data.success) {
                console.log('Success, displaying results');
                displayResults(data.results);
                loadingState.classList.add('hidden');
                resultsSection.classList.remove('hidden');
            } else {
                throw new Error(data.error || 'Analysis failed');
            }
        } catch (error) {
            console.error('Error occurred:', error);
            loadingState.classList.add('hidden');
            showError(error.message || 'An unexpected error occurred');
        }
    });

    // Try again button handler
    tryAgainBtn.addEventListener('click', function() {
        showForm();
    });

    // New analysis button handler
    document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'newAnalysisBtn') {
            showForm();
        }
    });

    function showForm() {
        form.style.display = 'block';
        loadingState.classList.add('hidden');
        errorState.classList.add('hidden');
        resultsSection.classList.add('hidden');
        // Clear the form
        form.reset();
    }

    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        errorState.classList.remove('hidden');
        form.style.display = 'none';
    }

    function displayResults(results) {
        console.log('Displaying results:', results);
        
        // Update scores
        document.getElementById('overallScore').textContent = results.overall_score;
        document.getElementById('techScore').textContent = results.technical_score;
        document.getElementById('contentScore').textContent = results.content_score;
        document.getElementById('performanceScore').textContent = results.performance_score;

        // Create score charts
        try {
            createScoreChart('overallScoreChart', results.overall_score);
            createScoreChart('techScoreChart', results.technical_score);
            createScoreChart('contentScoreChart', results.content_score);
            createScoreChart('performanceScoreChart', results.performance_score);
        } catch (chartError) {
            console.error('Chart creation error:', chartError);
        }

        // Populate issues
        populateIssues('criticalIssues', results.critical_issues || []);
        populateIssues('warnings', results.warnings || []);
    }

    function createScoreChart(canvasId, score) {
        console.log('Creating chart for:', canvasId, 'with score:', score);
        
        if (typeof Chart === 'undefined') {
            console.error('Chart.js not loaded!');
            return;
        }
        
        const canvas = document.getElementById(canvasId);
        if (!canvas) {
            console.error('Canvas not found:', canvasId);
            return;
        }
        
        const ctx = canvas.getContext('2d');
        const color = score >= 80 ? '#10B981' : score >= 60 ? '#F59E0B' : '#EF4444';
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [score, 100 - score],
                    backgroundColor: [color, '#E5E7EB'],
                    borderWidth: 0,
                }]
            },
            options: {
                cutout: '75%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                maintainAspectRatio: false
            }
        });
    }

    function populateIssues(containerId, issues) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        if (issues.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center">No issues found!</p>';
            return;
        }
        
        issues.forEach(issue => {
            const div = document.createElement('div');
            div.className = 'p-4 bg-gray-50 rounded-lg';
            div.innerHTML = `
                <h4 class="font-semibold text-gray-900 mb-1">${issue.title}</h4>
                <p class="text-gray-600 text-sm">${issue.description}</p>
            `;
            container.appendChild(div);
        });
    }
});
</script>
{% endblock %}